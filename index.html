<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Werewolf Online - Ultimate V3</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            color: #f8fafc;
            min-height: 100dvh; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background 1.5s ease-in-out;
            background-color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Thematic Backgrounds */
        body.theme-night { background: radial-gradient(circle at 50% 0%, #1e293b, #020617 100%); }
        body.theme-day { background: radial-gradient(circle at 50% 0%, #0284c7, #0f172a 100%); }
        body.theme-blood { background: radial-gradient(circle at 50% 0%, #991b1b, #020617 100%); }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.7);
        }

        .screen { transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); width: 100%; max-width: 600px; padding: 1rem; }
        .hide-screen { opacity: 0; transform: translateY(30px) scale(0.95); pointer-events: none; position: absolute; visibility: hidden; }
        .show-screen { opacity: 1; transform: translateY(0) scale(1); position: relative; visibility: visible; display: flex; flex-direction: column; align-items: center; }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î 3D ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö */
        .flip-card { width: 60vw; max-width: 220px; aspect-ratio: 2 / 3; perspective: 2000px; cursor: pointer; margin: 0 auto; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.25rem; box-shadow: 0 20px 40px rgba(0,0,0,0.8); overflow: hidden; }
        .flip-card-front { background: linear-gradient(135deg, #1e293b, #09090b); display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid #334155; }
        .flip-card-front .logo-mark { color: #ef4444; font-size: 2rem; font-weight: 900; letter-spacing: 2px; text-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }
        .flip-card-front .hint { color: #94a3b8; font-size: 0.9rem; margin-top: 1rem; }
        .flip-card-back { background-color: #000; transform: rotateY(180deg); border: 2px solid #ef4444; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        .flip-card-back img { width: 100%; height: 100%; object-fit: cover; opacity: 0.95; }

        .glow-text { text-shadow: 0 0 20px rgba(239, 68, 68, 0.8); }
        
        /* Toast UI */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 92%; max-width: 400px; }
        .toast { background: rgba(2, 6, 23, 0.95); border-left: 5px solid #3b82f6; color: white; padding: 16px 20px; border-radius: 16px; transform: translateY(-150%); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-weight: 600; box-shadow: 0 15px 30px rgba(0,0,0,0.6); display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.05);}
        .toast.show { transform: translateY(0); }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
        .toast.wolf { background: #450a0a; border-left-color: #ef4444; }
        
        /* Buttons */
        .btn-primary { width: 100%; background: linear-gradient(135deg, #ef4444, #991b1b); padding: 1.1rem; border-radius: 1.25rem; font-weight: 800; font-size: 1.2rem; transition: all 0.2s; box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4); color: white; border: 1px solid rgba(255,255,255,0.1);}
        .btn-primary:active { transform: scale(0.95); box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4); }
        
        /* Scrollbar ‡∏ã‡πà‡∏≠‡∏ô */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="theme-night">

    <div id="toast-container"></div>

    <div id="screen-login" class="screen show-screen">
        <div class="glass-panel p-8 md:p-12 rounded-[2.5rem] w-full text-center">
            <div class="inline-block animate-pulse mb-2">
                <span class="text-6xl">üê∫</span>
            </div>
            <h1 class="text-5xl sm:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-red-500 to-orange-500 mb-2 glow-text tracking-tight">WEREWOLF</h1>
            <p class="text-slate-400 mb-10 font-semibold tracking-widest uppercase">Ultimate V3</p>
            
            <input type="text" id="playerNameInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." class="w-full mb-6 px-5 py-4 bg-slate-900 border border-slate-700 rounded-2xl focus:border-red-500 outline-none text-center text-xl font-bold text-white transition-all shadow-inner">
            <button id="btnSaveName" class="btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen hide-screen" style="max-width: 800px;">
        <div class="glass-panel p-6 md:p-10 rounded-[2.5rem] w-full">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 border-b border-slate-700/50 pb-6">
                <h2 class="text-3xl font-black text-white">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô</h2>
                <div class="bg-slate-900 px-5 py-2.5 rounded-full border border-slate-700 flex items-center gap-3 w-full sm:w-auto justify-between shadow-inner">
                    <div class="flex items-center gap-2">
                        <div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></div>
                        <span id="displayPlayerName" class="font-bold text-slate-200"></span>
                    </div>
                    <button id="btnLogout" class="text-xs font-bold text-red-400 bg-red-500/10 px-3 py-1.5 rounded-full">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <div class="bg-slate-800/40 p-6 md:p-8 rounded-[2rem] border border-slate-700">
                    <h3 class="text-xl font-bold mb-5 text-white flex items-center gap-2">üëë ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
                    <input type="text" id="roomNameInput" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á..." class="w-full mb-4 px-4 py-3.5 bg-slate-900 rounded-xl border border-slate-700 focus:border-red-500 outline-none font-medium">
                    <select id="playerCount" class="w-full mb-6 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3.5 text-white outline-none font-medium">
                        <option value="5">‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å (5 ‡∏Ñ‡∏ô)</option>
                        <option value="7">‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á (7 ‡∏Ñ‡∏ô)</option>
                        <option value="10" selected>‡∏ß‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (10 ‡∏Ñ‡∏ô)</option>
                        <option value="15">‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà (15 ‡∏Ñ‡∏ô)</option>
                    </select>
                    <button id="btnCreateRoom" class="btn-primary" style="padding: 1rem;">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°</button>
                </div>

                <div class="bg-slate-800/40 p-6 md:p-8 rounded-[2rem] border border-slate-700 flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-bold mb-5 text-white flex items-center gap-2">ü§ù ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
                        <input type="text" id="joinRoomCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å" class="w-full mb-6 px-4 py-4 bg-slate-900 rounded-xl border border-slate-700 focus:border-blue-500 outline-none text-center text-2xl tracking-[0.25em] font-black uppercase text-blue-400 shadow-inner">
                    </div>
                    <button id="btnJoinRoom" class="btn-primary" style="background: linear-gradient(135deg, #2563eb, #1e3a8a); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3); padding: 1rem;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-room" class="screen hide-screen">
        <div class="glass-panel p-8 md:p-10 rounded-[2.5rem] w-full text-center">
            <div class="bg-slate-900 px-6 py-2.5 rounded-full border border-slate-700 mb-6 inline-flex items-center gap-3 shadow-inner">
                <span class="text-slate-400 text-sm font-bold uppercase tracking-widest">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á</span>
                <span id="roomIdDisplay" class="font-mono text-2xl font-black text-blue-400 tracking-widest">---</span>
            </div>
            <h2 id="roomTitleDisplay" class="text-4xl font-black text-white mb-8">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</h2>
            
            <div class="bg-slate-900/60 p-6 rounded-[2rem] border border-slate-700/50 mb-8 text-left">
                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h3>
                    <span class="bg-slate-800 px-3 py-1 rounded-full text-xs font-bold text-white"><span id="playerCountDisplay">0/0</span></span>
                </div>
                <div id="playerList" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 w-full">
                <button id="btnLeaveRoom" class="w-full sm:w-1/3 px-6 py-4 bg-slate-800 rounded-2xl font-bold text-slate-300 border border-slate-600 transition-all active:scale-95">‡∏´‡∏ô‡∏µ‡∏≠‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
                <button id="btnStartGame" class="btn-primary w-full sm:w-2/3 hidden">‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!</button>
            </div>
            <p id="waitingHostText" class="text-slate-400 mt-6 font-medium animate-pulse hidden">‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</p>
        </div>
    </div>

    <div id="screen-gameplay" class="screen hide-screen">
        
        <div id="gameStatusZone" class="glass-panel p-6 rounded-[2rem] w-full text-center mb-6 border-t-4 border-indigo-500 transition-all">
            <span id="dayCounter" class="bg-indigo-500/20 text-indigo-300 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-widest border border-indigo-500/30">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1</span>
            <h2 id="phaseTitle" class="text-4xl font-black text-white mt-4 mb-2">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô</h2>
            <p id="phaseDesc" class="text-slate-300 font-medium">‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div id="myCardZone" class="w-full mb-8 text-center">
            <div class="flip-card" id="myCard">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <div class="logo-mark">WEREWOLF</div>
                        <div class="hint">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                    </div>
                    <div class="flip-card-back"><img id="myRoleImage" src="" alt="Role"></div>
                </div>
            </div>
            <div class="mt-6 flex flex-col items-center">
                <span id="ghostBadge" class="bg-purple-600/20 text-purple-300 border border-purple-500/50 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-2 hidden">‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì üëª</span>
                <p class="text-3xl font-black text-white drop-shadow-lg" id="myRoleName">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</p>
            </div>
        </div>

        <div id="actionZone" class="glass-panel p-6 rounded-[2rem] w-full mb-6 border border-yellow-500/30 hidden shadow-[0_0_30px_rgba(234,179,8,0.1)]">
            <h3 id="actionTitle" class="text-xl font-black mb-4 text-yellow-400 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
            <div id="targetList" class="grid grid-cols-2 gap-3 mb-5"></div>
            <button id="btnConfirmAction" class="btn-primary hidden" style="background: linear-gradient(135deg, #d97706, #b45309); border:none;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</button>
        </div>

        <div id="aliveZone" class="bg-slate-900/90 p-6 rounded-[2rem] border border-slate-700 w-full text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-400 text-sm uppercase tracking-widest flex items-center gap-2">
                    üë• ‡∏ä‡∏≤‡∏ß‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
                    <span id="ghostVisionText" class="text-purple-400 text-xs hidden">(‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏û‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)</span>
                </h3>
                <span id="voteCountTracker" class="text-xs font-bold bg-slate-800 border border-slate-600 px-3 py-1.5 rounded-lg text-slate-300 hidden"></span>
            </div>
            <div id="aliveListUI" class="flex flex-col gap-2 mb-6"></div>
            
            <div id="hostTools" class="hidden border-t border-slate-700 pt-5 mt-2">
                <h4 class="text-xs text-slate-500 font-bold mb-3 uppercase tracking-widest">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏° (Host)</h4>
                <div class="flex gap-2">
                    <button id="btnHostForceDay" class="flex-1 bg-slate-800 hover:bg-slate-700 border border-slate-600 py-3 rounded-xl font-bold text-sm text-white transition-all">‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ü‡∏™ ‚è≠Ô∏è</button>
                    <button id="btnHostNewGame" class="flex-1 bg-red-900/50 hover:bg-red-800/80 border border-red-700 py-3 rounded-xl font-bold text-sm text-red-300 transition-all hidden">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö üîÑ</button>
                </div>
            </div>
        </div>
        
        <div id="gameLogZone" class="bg-slate-900/50 p-5 rounded-[1.5rem] border border-slate-800 w-full text-left mt-4 max-h-[150px] overflow-y-auto">
            <h3 class="font-bold text-slate-500 text-xs uppercase tracking-widest mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</h3>
            <div id="gameLogText" class="text-sm text-slate-400 flex flex-col gap-1"></div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const firebaseConfig = {
            apiKey: "AIzaSyAzA-3TJ4lcNOFUGoOVd8JhExoeIRxSsFU",
            authDomain: "wolf-ba81b.firebaseapp.com",
            projectId: "wolf-ba81b",
            storageBucket: "wolf-ba81b.firebasestorage.app",
            messagingSenderId: "310182298514",
            appId: "1:310182298514:web:804e92316d5aca0770b74b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global States
        let currentUser = localStorage.getItem('ww_name') || "";
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let isHost = false;
        let myRole = "";
        let isDead = false;
        let selectedTarget = null;
        let currentPhase = "";

        const roleImages = {
            "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤": "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤.jpg", "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô": "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô.jpg", 
            "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå": "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå.jpg", "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î": "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î.jpg",
            "‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à": "‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à.jpg", "‡∏Å‡∏≤‡∏°‡πÄ‡∏ó‡∏û": "‡∏Å‡∏≤‡∏°‡πÄ‡∏ó‡∏û.jpg", "‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó": "‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó.jpg", 
            "‡∏ô‡∏±‡∏Å‡∏ö‡∏ß‡∏ä": "‡∏ô‡∏±‡∏Å‡∏ö‡∏ß‡∏ä.jpg", "‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏≤‡∏¢": "‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏≤‡∏¢.jpg", "‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô": "‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô.jpg", "‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ": "‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ.jpg"
        };

        const showToast = (msg, type='info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type==='success'?'‚úÖ':type==='error'?'üíÄ':type==='wolf'?'üê∫':'üîî';
            toast.innerHTML = `<span class="text-2xl">${icon}</span> <span class="text-sm md:text-base">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.remove(),500); }, 3500);
        };

        const showScreen = (id) => {
            ['screen-login', 'screen-lobby', 'screen-room', 'screen-gameplay'].forEach(s => {
                const el = document.getElementById(s);
                if(s === id) { el.classList.remove('hide-screen'); el.classList.add('show-screen'); }
                else { el.classList.remove('show-screen'); el.classList.add('hide-screen'); }
            });
        };

        // ==========================================
        // ‡∏≠‡∏±‡∏•‡∏Å‡∏≠‡∏£‡∏¥‡∏ó‡∏∂‡∏°‡∏™‡∏∏‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î (Double Shuffle)
        // ==========================================
        const shuffleArray = (array) => {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const generateDeck = (count) => {
            let deck = ["‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤"]; 
            if (count >= 4) deck.push("‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå");
            if (count >= 5) deck.push("‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î");
            if (count >= 7) deck.push("‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤");
            if (count >= 9) deck.push("‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô");
            if (count >= 10) deck.push("‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à");
            while(deck.length < count) { deck.push("‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô"); }
            // ‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1
            return shuffleArray(deck);
        };

        // --- Flow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
        if(currentUser) { document.getElementById('displayPlayerName').textContent = currentUser; showScreen('screen-lobby'); } 
        else showScreen('screen-login');

        document.getElementById('btnSaveName').addEventListener('click', () => {
            const name = document.getElementById('playerNameInput').value.trim();
            if(name) { currentUser = name; localStorage.setItem('ww_name', name); document.getElementById('displayPlayerName').textContent = currentUser; showScreen('screen-lobby'); showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${name}!`, 'success'); } 
            else showToast('‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
        });
        document.getElementById('btnLogout').addEventListener('click', () => { localStorage.removeItem('ww_name'); currentUser = ""; document.getElementById('playerNameInput').value = ""; showScreen('screen-login'); });

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á ---
        const joinRoom = (roomId) => {
            currentRoomId = roomId; showScreen('screen-room'); document.getElementById('roomIdDisplay').textContent = roomId;
            unsubscribeRoom = onSnapshot(doc(db, "rooms", roomId), (docSnap) => {
                if(!docSnap.exists()) { showToast("‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß", 'error'); leaveRoom(); return; }
                const data = docSnap.data(); isHost = (data.host === currentUser);
                
                if(data.status === 'waiting') {
                    document.getElementById('roomTitleDisplay').textContent = data.name;
                    document.getElementById('playerCountDisplay').textContent = `${data.players.length}/${data.maxPlayers}`;
                    document.getElementById('playerList').innerHTML = data.players.map(p => 
                        `<div class="bg-slate-800 p-3 rounded-xl flex items-center gap-3 border ${p===data.host?'border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.2)]':'border-slate-700'}">
                            <div class="w-2.5 h-2.5 rounded-full ${p===data.host?'bg-red-500 animate-pulse':'bg-slate-400'}"></div>
                            <span class="font-bold text-sm text-white truncate">${p}</span>
                        </div>`
                    ).join('');
                    
                    if(isHost) { document.getElementById('btnStartGame').classList.remove('hidden'); document.getElementById('waitingHostText').classList.add('hidden'); } 
                    else { document.getElementById('btnStartGame').classList.add('hidden'); document.getElementById('waitingHostText').classList.remove('hidden'); }
                } else handleGameEngine(data);
            });
        };

        document.getElementById('btnCreateRoom').addEventListener('click', async () => {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            await setDoc(doc(db, "rooms", roomId), {
                name: document.getElementById('roomNameInput').value || `‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á ${currentUser}`,
                host: currentUser, maxPlayers: parseInt(document.getElementById('playerCount').value),
                status: "waiting", players: [currentUser], alive: [currentUser],
                roles: {}, phase: "setup", dayCount: 1, actions: {}, votes: {}, log: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢...", history: []
            });
            joinRoom(roomId);
        });

        document.getElementById('btnJoinRoom').addEventListener('click', async () => {
            const code = document.getElementById('joinRoomCode').value.toUpperCase();
            if(!code) return showToast('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
            const ref = doc(db, "rooms", code); const snap = await getDoc(ref);
            if(snap.exists() && snap.data().status === 'waiting') {
                if(!snap.data().players.includes(currentUser)) await updateDoc(ref, { players: arrayUnion(currentUser), alive: arrayUnion(currentUser) });
                joinRoom(code);
            } else showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)', 'error');
        });

        const leaveRoom = () => { if(unsubscribeRoom) unsubscribeRoom(); currentRoomId = null; showScreen('screen-lobby'); };
        document.getElementById('btnLeaveRoom').addEventListener('click', leaveRoom);

        // ==========================================
        // ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠ Host ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ñ‡∏≤‡∏ß‡∏£)
        // ==========================================
        document.getElementById('btnStartGame').addEventListener('click', async () => {
            const ref = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(ref);
            const players = snap.data().players;
            
            // 1. ‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà
            let shuffledDeck = generateDeck(players.length);
            // 2. ‡∏™‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏•‡πà‡∏ô (Double Shuffle!)
            let shuffledPlayers = shuffleArray(players); 

            // 3. ‡πÅ‡∏à‡∏Å‡πÑ‡∏û‡πà
            let rolesMap = {};
            shuffledPlayers.forEach((p, i) => rolesMap[p] = shuffledDeck[i]);

            await updateDoc(ref, { status: "playing", phase: "night", roles: rolesMap, log: "‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏£‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏ö‡πÉ‡∏´‡∏•...", history: ["‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÅ‡∏à‡∏Å‡πÑ‡∏û‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"] });
        });

        // ==========================================
        // ‡πÄ‡∏≠‡∏ô‡∏à‡∏¥‡πâ‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏°
        // ==========================================
        function handleGameEngine(data) {
            showScreen('screen-gameplay');
            currentPhase = data.phase;
            myRole = data.roles[currentUser] || "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô";
            isDead = !data.alive.includes(currentUser);

            // ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πå‡∏î & ‡∏õ‡πâ‡∏≤‡∏¢‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì
            document.getElementById('myRoleName').textContent = myRole;
            document.getElementById('myRoleImage').src = roleImages[myRole] || "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô.jpg";
            const ghostBadge = document.getElementById('ghostBadge');
            const ghostVisionText = document.getElementById('ghostVisionText');
            
            if(isDead) {
                ghostBadge.classList.remove('hidden');
                ghostVisionText.classList.remove('hidden');
            } else {
                ghostBadge.classList.add('hidden');
                ghostVisionText.classList.add('hidden');
            }

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° UI ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
            const actionZone = document.getElementById('actionZone');
            const targetList = document.getElementById('targetList');
            const phaseTitle = document.getElementById('phaseTitle');
            const phaseDesc = document.getElementById('phaseDesc');
            
            actionZone.classList.add('hidden'); targetList.innerHTML = '';
            document.getElementById('btnConfirmAction').classList.add('hidden');
            selectedTarget = null;
            document.getElementById('dayCounter').textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.dayCount}`;

            // ‡πÇ‡∏ä‡∏ß‡πå History Log
            const historyDiv = document.getElementById('gameLogText');
            historyDiv.innerHTML = data.history.map(h => `<span>‚Ä¢ ${h}</span>`).join('');

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏¢ ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)
            renderAliveList(data.players, data.alive, data.roles, isDead);

            // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ Host
            if(isHost) {
                document.getElementById('hostTools').classList.remove('hidden');
                const btnForce = document.getElementById('btnHostForceDay');
                const btnNew = document.getElementById('btnHostNewGame');
                
                if(currentPhase === "ended") { btnForce.classList.add('hidden'); btnNew.classList.remove('hidden'); }
                else { 
                    btnForce.classList.remove('hidden'); btnNew.classList.add('hidden');
                    btnForce.textContent = currentPhase === "night" ? "‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ ‚òÄÔ∏è" : "‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ ‚öñÔ∏è";
                    btnForce.onclick = () => {
                        const nextPhase = currentPhase === "night" ? "day" : currentPhase === "day" ? "voting" : "night";
                        updateDoc(doc(db, "rooms", currentRoomId), { phase: nextPhase, actions: {}, votes: {} });
                    };
                }
                
                btnNew.onclick = () => updateDoc(doc(db, "rooms", currentRoomId), { status: "waiting", phase: "setup", alive: data.players, log: "", history: [] });
            }

            // üåô ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô
            if(currentPhase === "night") {
                setTheme('theme-night');
                phaseTitle.textContent = "‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô";
                phaseDesc.textContent = "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...";
                document.getElementById('voteCountTracker').classList.add('hidden');

                if(myRole === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤" && !isDead && !data.actions[currentUser]) showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ!', 'wolf');

                if(!isDead && !data.actions[currentUser]) {
                    const aliveOthers = data.alive.filter(p => p !== currentUser);
                    if(myRole === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤") showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠ ü©∏", aliveOthers, "kill");
                    else if (myRole === "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå") showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏≠‡∏á üîÆ", aliveOthers, "check");
                    else if (myRole === "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î") showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô üõ°Ô∏è", data.alive, "protect");
                } else if (!isDead && data.actions[currentUser]) phaseDesc.textContent = "‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô...";
                else if (isDead) phaseDesc.textContent = "‡∏ô‡∏±‡πà‡∏á‡∏î‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ü§´";

                if(isHost) processNightEnd(data);
            } 
            // ‚òÄÔ∏è ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤
            else if (currentPhase === "day") {
                setTheme(data.log.includes("‡∏ï‡∏≤‡∏¢") ? 'theme-blood' : 'theme-day');
                phaseTitle.textContent = "‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ ‚òÄÔ∏è";
                phaseDesc.innerHTML = `<span class="font-bold text-xl text-white">${data.log}</span><br>‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ï‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!`;
            }
            // ‚öñÔ∏è ‡πÇ‡∏´‡∏ß‡∏ï‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£
            else if (currentPhase === "voting") {
                setTheme('theme-day');
                phaseTitle.textContent = "‡πÇ‡∏´‡∏ß‡∏ï‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£ ‚öñÔ∏è";
                phaseDesc.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤";
                
                const voteCount = Object.keys(data.votes || {}).length;
                const tracker = document.getElementById('voteCountTracker');
                tracker.textContent = `‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß ${voteCount}/${data.alive.length}`; tracker.classList.remove('hidden');

                if(!isDead && !data.votes[currentUser]) showActionPanel("‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ ü™¢", data.alive, "vote");
                else if (!isDead) phaseDesc.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ${data.alive.length - voteCount} ‡∏Ñ‡∏ô...`;

                if(isHost) processVoteEnd(data);
            }
            // üéä ‡∏à‡∏ö‡πÄ‡∏Å‡∏°
            else if (currentPhase === "ended") {
                setTheme(data.log.includes("‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô") ? 'theme-day' : 'theme-blood');
                phaseTitle.textContent = "‡∏à‡∏ö‡πÄ‡∏Å‡∏°! üéä";
                phaseDesc.innerHTML = `<span class="font-black text-2xl">${data.log}</span>`;
            }
        }

        function setTheme(themeName) { document.body.classList.remove('theme-night', 'theme-day', 'theme-blood'); document.body.classList.add(themeName); }

        function renderAliveList(allPlayers, alivePlayers, rolesMap, showAllRoles) {
            document.getElementById('aliveListUI').innerHTML = allPlayers.map(p => {
                const isAlive = alivePlayers.includes(p);
                const roleText = showAllRoles ? `<span class="text-xs ml-2 text-indigo-300">(${rolesMap[p]})</span>` : "";
                return `
                <div class="flex items-center justify-between p-3 rounded-xl border ${isAlive ? 'bg-slate-800 border-slate-600' : 'bg-red-900/20 border-red-900/50 opacity-60'}">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full ${isAlive ? 'bg-green-500' : 'bg-red-600'}"></div>
                        <span class="font-bold text-sm ${isAlive ? 'text-white' : 'text-red-500 line-through'}">${p} ${p===currentUser?'(‡∏Ñ‡∏∏‡∏ì)':''}</span>
                    </div>
                    ${roleText}
                </div>`;
            }).join('');
        }

        function showActionPanel(title, targets, type) {
            document.getElementById('actionZone').classList.remove('hidden'); document.getElementById('actionTitle').textContent = title;
            const list = document.getElementById('targetList');
            targets.forEach(t => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-800 hover:bg-slate-700 p-3 rounded-xl border border-slate-600 font-bold text-sm text-white transition-all";
                btn.textContent = t;
                btn.onclick = () => {
                    [...list.children].forEach(c => c.classList.remove('ring-2', 'ring-yellow-500', 'bg-slate-700'));
                    btn.classList.add('ring-2', 'ring-yellow-500', 'bg-slate-700'); selectedTarget = t;
                    document.getElementById('btnConfirmAction').classList.remove('hidden');
                    document.getElementById('btnConfirmAction').onclick = () => submitAction(type);
                };
                list.appendChild(btn);
            });
        }

        async function submitAction(type) {
            document.getElementById('actionZone').classList.add('hidden'); const ref = doc(db, "rooms", currentRoomId);
            if(type === "check") {
                const docSnap = await getDoc(ref); const role = docSnap.data().roles[selectedTarget];
                const isWolf = role === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤"; 
                showToast(`${selectedTarget} ${isWolf ? '‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤! üê∫' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ üßë‚Äçüåæ'}`, isWolf ? 'error' : 'success');
                await updateDoc(ref, { [`actions.${currentUser}`]: "checked" });
            } else if (type === "vote") await updateDoc(ref, { [`votes.${currentUser}`]: selectedTarget });
            else await updateDoc(ref, { [`actions.${currentUser}`]: { type: type, target: selectedTarget } });
        }

        async function processNightEnd(data) {
            const activeRoles = ["‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤", "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå", "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î"];
            const requiredActions = data.alive.filter(p => activeRoles.includes(data.roles[p]));
            const actionsDone = Object.keys(data.actions || {});

            if(actionsDone.length >= requiredActions.length && requiredActions.length > 0) {
                let wolfTarget = null; let protectTarget = null;
                Object.values(data.actions).forEach(action => {
                    if(action && action.type === 'kill') wolfTarget = action.target;
                    if(action && action.type === 'protect') protectTarget = action.target;
                });

                let msg = "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏á‡∏ö‡∏™‡∏∏‡∏Ç üïäÔ∏è"; let newAlive = [...data.alive];
                let historyLog = `‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.dayCount}: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ï‡∏≤‡∏¢`;

                if (wolfTarget && wolfTarget !== protectTarget) {
                    newAlive = newAlive.filter(p => p !== wolfTarget);
                    msg = `‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏¢ 1 ‡∏Ñ‡∏ô... ‡∏Ñ‡∏∑‡∏≠ ${wolfTarget} ü©∏`;
                    historyLog = `‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.dayCount}: ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Ü‡πà‡∏≤ ${wolfTarget}`;
                } else if (wolfTarget && wolfTarget === protectTarget) {
                    msg = "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ! üõ°Ô∏è";
                    historyLog = `‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.dayCount}: ‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏ã‡∏ü‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
                }

                await updateDoc(doc(db, "rooms", currentRoomId), { phase: "day", alive: newAlive, actions: {}, log: msg, history: arrayUnion(historyLog) });
                checkWin(newAlive, data.roles);
            }
        }

        async function processVoteEnd(data) {
            const votesDone = Object.keys(data.votes || {});
            if(votesDone.length >= data.alive.length) {
                const counts = {}; Object.values(data.votes).forEach(t => counts[t] = (counts[t] || 0) + 1);
                const hanged = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

                const newAlive = data.alive.filter(p => p !== hanged);
                const msg = `‡∏°‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£ ${hanged}! (‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏∑‡∏≠ ${data.roles[hanged]}) ü™¢`;
                const historyLog = `‡πÄ‡∏ä‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.dayCount}: ‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ ${hanged}`;

                await updateDoc(doc(db, "rooms", currentRoomId), { phase: "night", alive: newAlive, votes: {}, log: msg, dayCount: (data.dayCount || 1) + 1, history: arrayUnion(historyLog) });
                checkWin(newAlive, data.roles);
            }
        }

        async function checkWin(aliveList, rolesMap) {
            const wolves = aliveList.filter(p => rolesMap[p] === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤").length;
            const villagers = aliveList.length - wolves;

            let endMsg = null;
            if(wolves === 0) endMsg = "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ô‡∏∞! ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏™‡∏π‡∏ç‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå üéä";
            else if(wolves >= villagers) endMsg = "‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ä‡∏ô‡∏∞! ‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏£‡∏≠‡∏á‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô üê∫";

            if(endMsg) await updateDoc(doc(db, "rooms", currentRoomId), { phase: "ended", log: endMsg, history: arrayUnion(endMsg) });
        }

        document.getElementById('myCard').addEventListener('click', function() { this.classList.toggle('flipped'); });

    </script>
</body>
</html>
