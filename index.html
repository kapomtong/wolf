<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Werewolf Online - Ultimate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            color: #f8fafc;
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            min-height: 100dvh; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background 1s ease-in-out;
            background-color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        body.theme-night { background: radial-gradient(circle at 50% 0%, #1e293b, #020617 100%); }
        body.theme-day { background: radial-gradient(circle at 50% 0%, #0ea5e9, #0f172a 100%); }
        body.theme-blood { background: radial-gradient(circle at 50% 0%, #7f1d1d, #020617 100%); }

        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .screen { transition: opacity 0.4s ease, transform 0.4s ease; width: 100%; max-width: 600px; padding: 1rem; }
        .hide-screen { opacity: 0; transform: translateY(15px) scale(0.98); pointer-events: none; position: absolute; visibility: hidden; }
        .show-screen { opacity: 1; transform: translateY(0) scale(1); position: relative; visibility: visible; display: flex; flex-direction: column; align-items: center; }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏™‡∏∏‡∏î‡πÜ */
        .flip-card { 
            width: 65vw; /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á 65% ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            max-width: 240px; /* ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 240px ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏° */
            aspect-ratio: 2 / 3; 
            perspective: 1500px; 
            cursor: pointer; 
            margin: 0 auto; 
        }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1rem; box-shadow: 0 15px 35px rgba(0,0,0,0.6); overflow: hidden; }
        .flip-card-front { background: linear-gradient(135deg, #1e293b, #09090b); display: flex; align-items: center; justify-content: center; border: 2px solid #334155; }
        .flip-card-front::after { content: "WEREWOLF\A‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏û‡πà"; white-space: pre; color: #ef4444; font-size: 1.25rem; font-weight: 900; letter-spacing: 1px; }
        .flip-card-back { background-color: #000; transform: rotateY(180deg); border: 2px solid #ef4444; }
        .flip-card-back img { width: 100%; height: 100%; object-fit: cover; opacity: 0.95; }

        .glow-text { text-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }
        
        #toast-container { position: fixed; top: env(safe-area-inset-top, 16px); left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; width: 92%; max-width: 380px; }
        .toast { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #3b82f6; color: white; padding: 14px 16px; border-radius: 12px; transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px;}
        .toast.show { transform: translateY(10px); }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
        .toast.wolf { background: #450a0a; border-left-color: #ef4444; }
        
        /* ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î */
        .btn-primary { width: 100%; background: linear-gradient(to right, #dc2626, #991b1b); padding: 1rem; border-radius: 1rem; font-weight: 700; font-size: 1.125rem; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3); }
        .btn-primary:active { transform: scale(0.96); }
    </style>
</head>
<body class="theme-night">

    <div id="toast-container"></div>

    <div id="screen-login" class="screen show-screen">
        <div class="glass-panel p-8 md:p-10 rounded-3xl w-full text-center">
            <h1 class="text-4xl sm:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-br from-red-500 to-orange-600 mb-2 glow-text">WEREWOLF</h1>
            <p class="text-slate-400 mb-8 font-medium">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏∑‡πà‡∏ô</p>
            
            <input type="text" id="playerNameInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." class="w-full mb-6 px-4 py-3.5 bg-slate-900/80 border border-slate-700 rounded-2xl focus:border-red-500 outline-none text-center text-lg font-bold text-white transition-all">
            <button id="btnSaveName" class="btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen hide-screen" style="max-width: 800px;">
        <div class="glass-panel p-6 md:p-8 rounded-3xl w-full">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-3 border-b border-slate-700/50 pb-5">
                <h2 class="text-2xl font-black text-white">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏°</h2>
                <div class="bg-slate-900/80 px-4 py-2 rounded-full border border-slate-700 flex items-center gap-3 w-full sm:w-auto justify-between">
                    <span id="displayPlayerName" class="font-bold text-slate-200"></span>
                    <button id="btnLogout" class="text-xs font-bold text-red-400">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5 w-full">
                <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                    <h3 class="text-xl font-bold mb-4 text-white">üëë ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</h3>
                    <input type="text" id="roomNameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á..." class="w-full mb-4 px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 focus:border-red-500 outline-none">
                    <select id="playerCount" class="w-full mb-5 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white outline-none">
                        <option value="5">‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å (5 ‡∏Ñ‡∏ô)</option>
                        <option value="7">‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á (7 ‡∏Ñ‡∏ô)</option>
                        <option value="10" selected>‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà (10 ‡∏Ñ‡∏ô)</option>
                    </select>
                    <button id="btnCreateRoom" class="btn-primary" style="padding: 0.8rem;">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                </div>

                <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700 flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-bold mb-4 text-white">ü§ù ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h3>
                        <input type="text" id="joinRoomCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á 6 ‡∏´‡∏•‡∏±‡∏Å" class="w-full mb-5 px-4 py-4 bg-slate-900 rounded-xl border border-slate-700 focus:border-blue-500 outline-none text-center text-xl tracking-[0.2em] font-black uppercase text-blue-400">
                    </div>
                    <button id="btnJoinRoom" class="btn-primary" style="background: linear-gradient(to right, #2563eb, #1d4ed8); padding: 0.8rem;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏î‡πà‡∏ß‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-room" class="screen hide-screen">
        <div class="glass-panel p-6 md:p-8 rounded-3xl w-full text-center">
            <div class="bg-slate-900/80 px-5 py-2 rounded-full border border-slate-700 mb-4 inline-block">
                <span class="text-slate-400 text-sm font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á:</span>
                <span id="roomIdDisplay" class="font-mono text-xl font-bold text-blue-400 ml-2 tracking-widest">---</span>
            </div>
            <h2 id="roomTitleDisplay" class="text-3xl font-black text-white mb-6">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</h2>
            
            <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-700/50 mb-6 text-left">
                <h3 class="text-sm font-bold text-slate-400 mb-3">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (<span id="playerCountDisplay">0/0</span>)</h3>
                <div id="playerList" class="grid grid-cols-2 gap-2"></div>
            </div>

            <div class="flex gap-3 flex-col sm:flex-row">
                <button id="btnLeaveRoom" class="w-full sm:w-auto px-6 py-3.5 bg-slate-800 rounded-xl font-bold text-slate-300 border border-slate-600">‡∏≠‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
                <button id="btnStartGame" class="btn-primary hidden">‡πÅ‡∏à‡∏Å‡πÑ‡∏û‡πà!</button>
            </div>
            <p id="waitingHostText" class="text-slate-400 mt-4 font-medium animate-pulse hidden">‡∏£‡∏≠ Host ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</p>
        </div>
    </div>

    <div id="screen-gameplay" class="screen hide-screen">
        
        <div id="gameStatusZone" class="glass-panel p-6 rounded-3xl w-full text-center mb-5 border-t-4 border-indigo-500">
            <span id="dayCounter" class="bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-full text-xs font-bold uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1</span>
            <h2 id="phaseTitle" class="text-3xl font-black text-white mt-3 mb-1">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô</h2>
            <p id="phaseDesc" class="text-slate-300 text-sm md:text-base">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠...</p>
        </div>

        <div id="myCardZone" class="w-full mb-5 text-center">
            <div class="flip-card" id="myCard">
                <div class="flip-card-inner">
                    <div class="flip-card-front"></div>
                    <div class="flip-card-back"><img id="myRoleImage" src="" alt="Role"></div>
                </div>
            </div>
            <p class="mt-4 text-xl md:text-2xl font-black text-white" id="myRoleName">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</p>
        </div>

        <div id="actionZone" class="glass-panel p-5 rounded-3xl w-full mb-5 border border-yellow-500/30 hidden">
            <h3 id="actionTitle" class="text-lg font-bold mb-3 text-yellow-400 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
            <div id="targetList" class="grid grid-cols-2 gap-2 mb-4"></div>
            <button id="btnConfirmAction" class="btn-primary hidden" style="background: linear-gradient(to right, #d97706, #b45309); padding: 0.75rem;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>

        <div id="aliveZone" class="bg-slate-900/80 p-5 rounded-3xl border border-slate-700 w-full text-left">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-slate-400 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</h3>
                <span id="voteCountTracker" class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 hidden"></span>
            </div>
            <div id="aliveListUI" class="flex flex-wrap gap-2 mb-4"></div>
            <button id="btnHostForceDay" class="w-full bg-indigo-600 py-3 rounded-xl font-bold text-sm hidden shadow-lg">üëë ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏ß‡πà‡∏≤‡∏á (Host)</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAzA-3TJ4lcNOFUGoOVd8JhExoeIRxSsFU",
            authDomain: "wolf-ba81b.firebaseapp.com",
            projectId: "wolf-ba81b",
            storageBucket: "wolf-ba81b.firebasestorage.app",
            messagingSenderId: "310182298514",
            appId: "1:310182298514:web:804e92316d5aca0770b74b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = localStorage.getItem('ww_name') || "";
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let isHost = false;
        let myRole = "";
        let isDead = false;
        let selectedTarget = null;
        let currentPhase = "";

        const roleImages = {
            "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤": "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤.jpg", "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô": "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô.jpg", 
            "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå": "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå.jpg", "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î": "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î.jpg",
            "‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à": "‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à.jpg", "‡∏Å‡∏≤‡∏°‡πÄ‡∏ó‡∏û": "‡∏Å‡∏≤‡∏°‡πÄ‡∏ó‡∏û.jpg", "‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó": "‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó.jpg", 
            "‡∏ô‡∏±‡∏Å‡∏ö‡∏ß‡∏ä": "‡∏ô‡∏±‡∏Å‡∏ö‡∏ß‡∏ä.jpg", "‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏≤‡∏¢": "‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏≤‡∏¢.jpg", "‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô": "‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô.jpg", "‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ": "‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ.jpg"
        };

        const showToast = (msg, type='info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type==='success'?'‚úÖ':type==='error'?'‚ùå':type==='wolf'?'üê∫':'üîî';
            toast.innerHTML = `<span class="text-lg">${icon}</span> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.remove(),400); }, 3500);
        };

        const showScreen = (id) => {
            ['screen-login', 'screen-lobby', 'screen-room', 'screen-gameplay'].forEach(s => {
                const el = document.getElementById(s);
                if(s === id) { el.classList.remove('hide-screen'); el.classList.add('show-screen'); }
                else { el.classList.remove('show-screen'); el.classList.add('hide-screen'); }
            });
        };

        // üé≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° Cryptographic Random (‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πâ 100% ‡πÑ‡∏£‡πâ‡∏≠‡∏Ñ‡∏ï‡∏¥)
        const cryptoShuffle = (array) => {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const randomBuffer = new Uint32Array(1);
                window.crypto.getRandomValues(randomBuffer);
                // ‡∏´‡∏≤‡∏£‡πÄ‡∏≠‡∏≤‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ index ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ó‡πâ‡πÜ
                const j = randomBuffer[0] % (i + 1);
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const generateDeck = (count) => {
            let deck = ["‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤"]; 
            if (count >= 5) deck.push("‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå");
            if (count >= 6) deck.push("‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î");
            if (count >= 7) deck.push("‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤");
            if (count >= 9) deck.push("‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô");
            if (count >= 10) deck.push("‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à");
            while(deck.length < count) { deck.push("‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô"); }
            // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
            return cryptoShuffle(deck);
        };

        // --- Core Application flow remains the same, adjusted styling hooks ---
        if(currentUser) {
            document.getElementById('displayPlayerName').textContent = currentUser;
            showScreen('screen-lobby');
        } else showScreen('screen-login');

        document.getElementById('btnSaveName').addEventListener('click', () => {
            const name = document.getElementById('playerNameInput').value.trim();
            if(name) { 
                currentUser = name; localStorage.setItem('ww_name', name); 
                document.getElementById('displayPlayerName').textContent = currentUser; 
                showScreen('screen-lobby'); showToast(`‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${name}!`, 'success');
            } else showToast('‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('ww_name'); currentUser = "";
            document.getElementById('playerNameInput').value = "";
            showScreen('screen-login');
        });

        const joinRoom = (roomId) => {
            currentRoomId = roomId;
            showScreen('screen-room');
            document.getElementById('roomIdDisplay').textContent = roomId;

            unsubscribeRoom = onSnapshot(doc(db, "rooms", roomId), (docSnap) => {
                if(!docSnap.exists()) { showToast("‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß", 'error'); leaveRoom(); return; }
                const data = docSnap.data();
                isHost = (data.host === currentUser);
                
                if(data.status === 'waiting') {
                    document.getElementById('roomTitleDisplay').textContent = data.name;
                    document.getElementById('playerCountDisplay').textContent = `${data.players.length}/${data.maxPlayers}`;
                    document.getElementById('playerList').innerHTML = data.players.map(p => 
                        `<div class="bg-slate-800/80 p-2.5 rounded-lg flex items-center gap-2 border ${p===data.host?'border-red-500':'border-slate-700'}">
                            <div class="w-1.5 h-1.5 rounded-full ${p===data.host?'bg-red-500':'bg-slate-400'}"></div>
                            <span class="font-bold truncate text-sm">${p}</span>
                        </div>`
                    ).join('');
                    
                    if(isHost) {
                        document.getElementById('btnStartGame').classList.remove('hidden');
                        document.getElementById('waitingHostText').classList.add('hidden');
                    } else {
                        document.getElementById('btnStartGame').classList.add('hidden');
                        document.getElementById('waitingHostText').classList.remove('hidden');
                    }
                } else {
                    handleGameEngine(data);
                }
            });
        };

        document.getElementById('btnCreateRoom').addEventListener('click', async () => {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            await setDoc(doc(db, "rooms", roomId), {
                name: document.getElementById('roomNameInput').value || `‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á ${currentUser}`,
                host: currentUser, maxPlayers: parseInt(document.getElementById('playerCount').value),
                status: "waiting", players: [currentUser], alive: [currentUser],
                roles: {}, phase: "setup", dayCount: 1, actions: {}, votes: {}, log: ""
            });
            joinRoom(roomId);
        });

        document.getElementById('btnJoinRoom').addEventListener('click', async () => {
            const code = document.getElementById('joinRoomCode').value.toUpperCase();
            if(!code) return showToast('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
            const ref = doc(db, "rooms", code);
            const snap = await getDoc(ref);
            if(snap.exists() && snap.data().status === 'waiting') {
                if(!snap.data().players.includes(currentUser)) await updateDoc(ref, { players: arrayUnion(currentUser), alive: arrayUnion(currentUser) });
                joinRoom(code);
            } else showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î / ‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
        });

        const leaveRoom = () => { if(unsubscribeRoom) unsubscribeRoom(); currentRoomId = null; showScreen('screen-lobby'); };
        document.getElementById('btnLeaveRoom').addEventListener('click', leaveRoom);

        document.getElementById('btnStartGame').addEventListener('click', async () => {
            const ref = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(ref);
            const players = snap.data().players;
            
            // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
            let deck = generateDeck(players.length);
            let roles = {};
            players.forEach((p, i) => roles[p] = deck[i]);

            await updateDoc(ref, { status: "playing", phase: "night", roles: roles, log: "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤... ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏£‡∏Å" });
            showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° 100%', 'info');
        });

        function handleGameEngine(data) {
            showScreen('screen-gameplay');
            currentPhase = data.phase;
            myRole = data.roles[currentUser] || "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô";
            isDead = !data.alive.includes(currentUser);

            document.getElementById('myRoleName').textContent = myRole;
            document.getElementById('myRoleImage').src = roleImages[myRole] || "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô.jpg";
            if(isDead) document.getElementById('myRoleName').textContent = myRole + " (‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì üëª)";

            const actionZone = document.getElementById('actionZone');
            const targetList = document.getElementById('targetList');
            const phaseTitle = document.getElementById('phaseTitle');
            const phaseDesc = document.getElementById('phaseDesc');
            
            actionZone.classList.add('hidden');
            targetList.innerHTML = '';
            document.getElementById('btnConfirmAction').classList.add('hidden');
            selectedTarget = null;
            document.getElementById('dayCounter').textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.dayCount}`;

            renderAliveList(data.players, data.alive);

            if(currentPhase === "night") {
                setTheme('theme-night');
                phaseTitle.textContent = "‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô";
                phaseDesc.textContent = "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...";
                document.getElementById('btnHostForceDay').classList.add('hidden');
                document.getElementById('voteCountTracker').classList.add('hidden');

                if(myRole === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤" && !isDead && !data.actions[currentUser]) showToast('‡∏ï‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠!', 'wolf');

                if(!isDead && !data.actions[currentUser]) {
                    const aliveOthers = data.alive.filter(p => p !== currentUser);
                    if(myRole === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤") showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠ ü©∏", aliveOthers, "kill");
                    else if (myRole === "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå") showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏≠‡∏á üîÆ", aliveOthers, "check");
                    else if (myRole === "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î") showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô üõ°Ô∏è", data.alive, "protect");
                } else if (!isDead && data.actions[currentUser]) phaseDesc.textContent = "‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÄ‡∏ä‡πâ‡∏≤...";
                else if (isDead) phaseDesc.textContent = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì...";

                if(isHost) processNightEnd(data);
            } 
            else if (currentPhase === "day") {
                setTheme(data.log.includes("‡∏ï‡∏≤‡∏¢") ? 'theme-blood' : 'theme-day');
                phaseTitle.textContent = "‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ ‚òÄÔ∏è";
                phaseDesc.innerHTML = `<span class="font-bold text-lg text-white">${data.log}</span><br>‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏±‡∏ô‡∏´‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡πÄ‡∏•‡∏¢!`;
                
                if(isHost) {
                    document.getElementById('btnHostForceDay').textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ ‚öñÔ∏è";
                    document.getElementById('btnHostForceDay').classList.remove('hidden');
                    document.getElementById('btnHostForceDay').onclick = () => updateDoc(doc(db, "rooms", currentRoomId), { phase: "voting", votes: {} });
                }
            }
            else if (currentPhase === "voting") {
                setTheme('theme-day');
                phaseTitle.textContent = "‡πÇ‡∏´‡∏ß‡∏ï‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£ ‚öñÔ∏è";
                phaseDesc.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤";
                document.getElementById('btnHostForceDay').classList.add('hidden');
                
                const voteCount = Object.keys(data.votes || {}).length;
                const tracker = document.getElementById('voteCountTracker');
                tracker.textContent = `‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß: ${voteCount}/${data.alive.length}`;
                tracker.classList.remove('hidden');

                if(!isDead && !data.votes[currentUser]) showActionPanel("‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠", data.alive, "vote");
                else if (!isDead) phaseDesc.textContent = `‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ${data.alive.length - voteCount} ‡∏Ñ‡∏ô...`;

                if(isHost) processVoteEnd(data);
            }
            else if (currentPhase === "ended") {
                setTheme(data.log.includes("‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô") ? 'theme-day' : 'theme-blood');
                phaseTitle.textContent = "‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß! üéä";
                phaseDesc.innerHTML = `<span class="font-bold text-xl">${data.log}</span>`;
            }
        }

        function setTheme(themeName) {
            document.body.classList.remove('theme-night', 'theme-day', 'theme-blood');
            document.body.classList.add(themeName);
        }

        function renderAliveList(allPlayers, alivePlayers) {
            document.getElementById('aliveListUI').innerHTML = allPlayers.map(p => {
                const isAlive = alivePlayers.includes(p);
                return `<span class="px-2.5 py-1 rounded text-sm font-bold border ${isAlive ? 'bg-slate-800 border-slate-600' : 'bg-red-900/30 border-red-900 text-red-500 line-through opacity-60'}">${p}</span>`;
            }).join('');
        }

        function showActionPanel(title, targets, type) {
            document.getElementById('actionZone').classList.remove('hidden');
            document.getElementById('actionTitle').textContent = title;
            const list = document.getElementById('targetList');
            
            targets.forEach(t => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-800 p-2.5 rounded-lg border border-slate-600 font-bold transition-all";
                btn.textContent = t;
                btn.onclick = () => {
                    [...list.children].forEach(c => c.classList.remove('ring-2', 'ring-yellow-500', 'bg-slate-700'));
                    btn.classList.add('ring-2', 'ring-yellow-500', 'bg-slate-700');
                    selectedTarget = t;
                    document.getElementById('btnConfirmAction').classList.remove('hidden');
                    document.getElementById('btnConfirmAction').onclick = () => submitAction(type);
                };
                list.appendChild(btn);
            });
        }

        async function submitAction(type) {
            document.getElementById('actionZone').classList.add('hidden');
            const ref = doc(db, "rooms", currentRoomId);
            
            if(type === "check") {
                const docSnap = await getDoc(ref);
                const role = docSnap.data().roles[selectedTarget];
                const isWolf = role === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤"; 
                showToast(`${selectedTarget} ${isWolf ? '‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤! üê∫' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ üßë‚Äçüåæ'}`, isWolf ? 'error' : 'success');
                await updateDoc(ref, { [`actions.${currentUser}`]: "checked" });
            } else if (type === "vote") {
                await updateDoc(ref, { [`votes.${currentUser}`]: selectedTarget });
            } else { 
                await updateDoc(ref, { [`actions.${currentUser}`]: { type: type, target: selectedTarget } });
            }
        }

        async function processNightEnd(data) {
            const activeRoles = ["‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤", "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå", "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î"];
            const requiredActions = data.alive.filter(p => activeRoles.includes(data.roles[p]));
            const actionsDone = Object.keys(data.actions || {});

            if(actionsDone.length >= requiredActions.length && requiredActions.length > 0) {
                let wolfTarget = null;
                let protectTarget = null;

                Object.values(data.actions).forEach(action => {
                    if(action && action.type === 'kill') wolfTarget = action.target;
                    if(action && action.type === 'protect') protectTarget = action.target;
                });

                let msg = "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏á‡∏ö‡∏™‡∏∏‡∏Ç üïäÔ∏è";
                let newAlive = [...data.alive];

                if (wolfTarget && wolfTarget !== protectTarget) {
                    newAlive = newAlive.filter(p => p !== wolfTarget);
                    msg = `‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏®‡∏û‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á ${wolfTarget} ü©∏`;
                } else if (wolfTarget && wolfTarget === protectTarget) {
                    msg = "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ! üõ°Ô∏è";
                }

                await updateDoc(doc(db, "rooms", currentRoomId), { phase: "day", alive: newAlive, actions: {}, log: msg });
                checkWin(newAlive, data.roles);
            }
        }

        async function processVoteEnd(data) {
            const votesDone = Object.keys(data.votes || {});
            if(votesDone.length >= data.alive.length) {
                const counts = {};
                Object.values(data.votes).forEach(t => counts[t] = (counts[t] || 0) + 1);
                const hanged = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

                const newAlive = data.alive.filter(p => p !== hanged);
                const msg = `‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ ${hanged}! (‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏∑‡∏≠ ${data.roles[hanged]}) ü™¢`;

                await updateDoc(doc(db, "rooms", currentRoomId), { phase: "night", alive: newAlive, votes: {}, log: msg, dayCount: (data.dayCount || 1) + 1 });
                checkWin(newAlive, data.roles);
            }
        }

        async function checkWin(aliveList, rolesMap) {
            const wolves = aliveList.filter(p => rolesMap[p] === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤").length;
            const villagers = aliveList.length - wolves;

            let endMsg = null;
            if(wolves === 0) endMsg = "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ô‡∏∞! ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß üéä";
            else if(wolves >= villagers) endMsg = "‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ä‡∏ô‡∏∞! üê∫";

            if(endMsg) await updateDoc(doc(db, "rooms", currentRoomId), { phase: "ended", log: endMsg });
        }

        document.getElementById('myCard').addEventListener('click', function() { this.classList.toggle('flipped'); });

    </script>
</body>
</html>
