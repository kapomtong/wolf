<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Werewolf Online - Ultimate Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background 1s ease-in-out;
            background-color: #0f172a;
        }
        /* ‡∏ò‡∏µ‡∏°‡πÅ‡∏ö‡∏ö Dynamic */
        body.theme-night { background: radial-gradient(circle at 50% 0%, #1e293b, #020617 80%); }
        body.theme-day { background: radial-gradient(circle at 50% 0%, #0ea5e9, #0f172a 90%); }
        body.theme-blood { background: radial-gradient(circle at 50% 0%, #7f1d1d, #020617 80%); }

        .glass-panel {
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .screen { transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .hide-screen { opacity: 0; transform: translateY(20px) scale(0.95); pointer-events: none; position: absolute; visibility: hidden; }
        .show-screen { opacity: 1; transform: translateY(0) scale(1); position: relative; visibility: visible; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î 3D ‡∏™‡∏ß‡∏¢‡πÜ */
        .flip-card { width: 100%; max-width: 260px; aspect-ratio: 2/3; perspective: 1500px; cursor: pointer; margin: 0 auto; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.25rem; box-shadow: 0 15px 35px rgba(0,0,0,0.6); overflow: hidden; }
        .flip-card-front { background: linear-gradient(135deg, #1e293b, #09090b); display: flex; align-items: center; justify-content: center; border: 2px solid #334155; }
        .flip-card-front::after { content: "WEREWOLF\A‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó"; white-space: pre; color: #ef4444; font-size: 1.5rem; font-weight: 900; letter-spacing: 2px; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        .flip-card-back { background-color: #000; transform: rotateY(180deg); border: 2px solid #ef4444; }
        .flip-card-back img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }

        /* ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á */
        .glow-text { text-shadow: 0 0 20px rgba(239, 68, 68, 0.6); }
        
        /* ‡∏Ç‡∏µ‡∏î‡∏ó‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏¢ */
        .is-dead { opacity: 0.5; text-decoration: line-through; color: #ef4444 !important; }
        
        /* Toast */
        #toast-container { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 400px; }
        .toast { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #3b82f6; color: white; padding: 16px; border-radius: 12px; transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .toast.show { transform: translateY(0); }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
        .toast.wolf { background: #450a0a; border-left-color: #ef4444; }
    </style>
</head>
<body class="flex items-center justify-center p-4 md:p-6 theme-night">

    <div id="toast-container"></div>

    <div id="screen-login" class="screen show-screen glass-panel p-8 md:p-12 rounded-[2rem] w-full max-w-md text-center">
        <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-br from-red-500 to-orange-600 mb-2 glow-text">WEREWOLF</h1>
        <p class="text-slate-400 mb-8 font-medium">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏∑‡πà‡∏ô</p>
        
        <div class="relative mb-6">
            <input type="text" id="playerNameInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." class="w-full px-5 py-4 bg-slate-900/80 border border-slate-700 rounded-2xl focus:border-red-500 focus:ring-2 focus:ring-red-500/20 outline-none text-center text-xl font-bold text-white placeholder-slate-500 transition-all">
        </div>
        <button id="btnSaveName" class="w-full bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 py-4 rounded-2xl font-bold text-xl transition-all transform active:scale-95 shadow-[0_0_20px_rgba(239,68,68,0.4)]">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
        </button>
    </div>

    <div id="screen-lobby" class="screen hide-screen glass-panel p-6 md:p-10 rounded-[2rem] w-full max-w-4xl">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 border-b border-slate-700/50 pb-6 gap-4">
            <h2 class="text-3xl font-black text-white tracking-wide">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô<span class="text-red-500">‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏∑‡πà‡∏ô</span></h2>
            <div class="bg-slate-900/80 px-5 py-2.5 rounded-full border border-slate-700 flex items-center gap-4 shadow-inner">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <span id="displayPlayerName" class="font-bold text-lg text-white"></span>
                <button id="btnLogout" class="text-xs font-bold text-red-400 hover:text-red-300 ml-2">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
            <div class="bg-slate-800/50 p-6 md:p-8 rounded-3xl border border-slate-700 hover:border-red-500/50 transition-colors group">
                <div class="w-12 h-12 bg-red-500/20 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-red-500/30 transition-colors">
                    <span class="text-2xl">üëë</span>
                </div>
                <h3 class="text-2xl font-bold mb-4 text-white">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
                <input type="text" id="roomNameInput" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á..." class="w-full mb-4 px-4 py-3 bg-slate-900 rounded-xl border border-slate-700 focus:border-red-500 outline-none font-medium">
                <select id="playerCount" class="w-full mb-6 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white font-medium outline-none">
                    <option value="5">‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å (5 ‡∏Ñ‡∏ô)</option>
                    <option value="7">‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á (7 ‡∏Ñ‡∏ô)</option>
                    <option value="10" selected>‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà (10 ‡∏Ñ‡∏ô)</option>
                    <option value="15">‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ (15 ‡∏Ñ‡∏ô)</option>
                </select>
                <button id="btnCreateRoom" class="w-full bg-red-600 hover:bg-red-500 py-3.5 rounded-xl font-bold text-lg transition-all active:scale-95 shadow-lg">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <div class="bg-slate-800/50 p-6 md:p-8 rounded-3xl border border-slate-700 hover:border-blue-500/50 transition-colors group flex flex-col justify-between">
                <div>
                    <div class="w-12 h-12 bg-blue-500/20 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-blue-500/30 transition-colors">
                        <span class="text-2xl">ü§ù</span>
                    </div>
                    <h3 class="text-2xl font-bold mb-4 text-white">‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç‡πÅ‡∏•‡πâ‡∏ß?</h3>
                    <input type="text" id="joinRoomCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å" class="w-full mb-6 px-4 py-4 bg-slate-900 rounded-xl border border-slate-700 focus:border-blue-500 outline-none text-center text-2xl tracking-[0.2em] font-black uppercase text-blue-400 placeholder-slate-600">
                </div>
                <button id="btnJoinRoom" class="w-full bg-blue-600 hover:bg-blue-500 py-3.5 rounded-xl font-bold text-lg transition-all active:scale-95 shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏î‡πà‡∏ß‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="screen-room" class="screen hide-screen glass-panel p-6 md:p-10 rounded-[2rem] w-full max-w-4xl text-center">
        <div class="inline-block bg-slate-900/80 px-6 py-2 rounded-full border border-slate-700 mb-4 shadow-inner">
            <span class="text-slate-400 text-sm font-semibold uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á:</span>
            <span id="roomIdDisplay" class="font-mono text-xl font-bold text-blue-400 ml-2 tracking-widest">---</span>
        </div>
        <h2 id="roomTitleDisplay" class="text-3xl md:text-5xl font-black text-white mb-8 drop-shadow-lg">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</h2>
        
        <div class="bg-slate-900/50 p-6 rounded-3xl border border-slate-700/50 mb-8">
            <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (<span id="playerCountDisplay">0/0</span>)</h3>
            <div id="playerList" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-left"></div>
        </div>

        <div class="flex gap-4">
            <button id="btnLeaveRoom" class="px-6 py-4 bg-slate-800 hover:bg-slate-700 rounded-2xl font-bold border border-slate-600 transition-all active:scale-95 text-slate-300">‡∏≠‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
            <button id="btnStartGame" class="flex-1 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 py-4 rounded-2xl font-black text-xl transition-all shadow-[0_0_20px_rgba(239,68,68,0.4)] active:scale-95 hidden">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà!</button>
        </div>
        <p id="waitingHostText" class="text-slate-400 mt-4 font-medium animate-pulse hidden">‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</p>
    </div>

    <div id="screen-gameplay" class="screen hide-screen w-full max-w-2xl text-center p-4">
        
        <div id="gameStatusZone" class="glass-panel p-6 rounded-[2rem] mb-6 border-t-4 border-indigo-500 shadow-2xl transition-all">
            <span id="dayCounter" class="bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1</span>
            <h2 id="phaseTitle" class="text-3xl md:text-4xl font-black text-white mt-3 mb-2">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô</h2>
            <p id="phaseDesc" class="text-lg text-slate-300">‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠...</p>
        </div>

        <div id="myCardZone" class="mb-8">
            <div class="flip-card" id="myCard">
                <div class="flip-card-inner">
                    <div class="flip-card-front"></div>
                    <div class="flip-card-back"><img id="myRoleImage" src="" alt="Role"></div>
                </div>
            </div>
            <p class="mt-5 text-2xl font-black text-white drop-shadow-md" id="myRoleName">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</p>
        </div>

        <div id="actionZone" class="glass-panel p-6 rounded-[2rem] mb-6 border border-yellow-500/30 hidden">
            <h3 id="actionTitle" class="text-xl font-bold mb-4 text-yellow-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
            <div id="targetList" class="grid grid-cols-2 gap-3 mb-4"></div>
            <button id="btnConfirmAction" class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 py-3.5 rounded-xl font-bold text-lg shadow-lg active:scale-95 hidden transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>

        <div id="aliveZone" class="bg-slate-900/80 p-6 rounded-[2rem] border border-slate-700 text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-400 uppercase tracking-widest text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≤‡∏ß‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</h3>
                <span id="voteCountTracker" class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 hidden"></span>
            </div>
            <div id="aliveListUI" class="flex flex-wrap gap-2"></div>
            
            <button id="btnHostForceDay" class="mt-6 w-full bg-indigo-600 py-3 rounded-xl font-bold text-sm hidden">üëë ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏ß‡πà‡∏≤‡∏á (Host Only)</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // *** ‡πÉ‡∏™‡πà Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
        const firebaseConfig = {
            apiKey: "AIzaSyAzA-3TJ4lcNOFUGoOVd8JhExoeIRxSsFU",
            authDomain: "wolf-ba81b.firebaseapp.com",
            projectId: "wolf-ba81b",
            storageBucket: "wolf-ba81b.firebasestorage.app",
            messagingSenderId: "310182298514",
            appId: "1:310182298514:web:804e92316d5aca0770b74b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State variables
        let currentUser = localStorage.getItem('ww_name') || "";
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let isHost = false;
        let myRole = "";
        let isDead = false;
        let selectedTarget = null;
        let currentPhase = "";

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢
        const roleImages = {
            "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤": "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤.jpg",
            "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô": "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô.jpg",
            "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå": "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå.jpg",
            "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î": "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î.jpg",
            "‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à": "‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à.jpg",
            "‡∏Å‡∏≤‡∏°‡πÄ‡∏ó‡∏û": "‡∏Å‡∏≤‡∏°‡πÄ‡∏ó‡∏û.jpg",
            "‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó": "‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó.jpg",
            "‡∏ô‡∏±‡∏Å‡∏ö‡∏ß‡∏ä": "‡∏ô‡∏±‡∏Å‡∏ö‡∏ß‡∏ä.jpg",
            "‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏≤‡∏¢": "‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏≤‡∏¢.jpg",
            "‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô": "‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô.jpg",
            "‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ": "‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ.jpg"
        };

        // --- Helper Functions ---
        const showToast = (msg, type='info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type} flex gap-3 items-center`;
            const icon = type==='success'?'‚úÖ':type==='error'?'‚ùå':type==='wolf'?'üê∫':'üîî';
            toast.innerHTML = `<span class="text-xl">${icon}</span> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.remove(),400); }, 3500);
        };

        const showScreen = (id) => {
            ['screen-login', 'screen-lobby', 'screen-room', 'screen-gameplay'].forEach(s => {
                document.getElementById(s).classList.toggle('hide-screen', s !== id);
                document.getElementById(s).classList.toggle('show-screen', s === id);
            });
        };

        // Algorithm ‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà‡πÅ‡∏ö‡∏ö Fisher-Yates (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ï‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏™‡∏°‡∏≠)
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        // Algorithm ‡∏à‡∏±‡∏î‡πÄ‡∏î‡πá‡∏Ñ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
        const generateDeck = (count) => {
            let deck = ["‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤"]; // ‡∏¢‡∏∑‡∏ô‡∏û‡∏∑‡πâ‡∏ô 1 ‡∏ï‡∏±‡∏ß
            if (count >= 5) deck.push("‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå"); // [cite: 20]
            if (count >= 6) deck.push("‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î"); // [cite: 24]
            if (count >= 7) deck.push("‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤"); // ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2
            if (count >= 9) deck.push("‡∏ô‡∏≤‡∏¢‡∏û‡∏£‡∏≤‡∏ô");
            if (count >= 10) deck.push("‡∏ô‡∏≤‡∏á‡∏õ‡∏µ‡∏®‡∏≤‡∏à");
            
            // ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°
            while(deck.length < count) {
                deck.push("‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô"); // [cite: 19]
            }
            return shuffleArray(deck);
        };

        // --- Login Logic ---
        if(currentUser) {
            document.getElementById('displayPlayerName').textContent = currentUser;
            showScreen('screen-lobby');
        } else {
            showScreen('screen-login');
        }

        document.getElementById('btnSaveName').addEventListener('click', () => {
            const name = document.getElementById('playerNameInput').value.trim();
            if(name) { 
                currentUser = name; localStorage.setItem('ww_name', name); 
                document.getElementById('displayPlayerName').textContent = currentUser; 
                showScreen('screen-lobby'); 
                showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${name}`, 'success');
            } else {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
            }
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('ww_name'); currentUser = "";
            document.getElementById('playerNameInput').value = "";
            showScreen('screen-login');
        });

        // --- Room Logic ---
        const joinRoom = (roomId) => {
            currentRoomId = roomId;
            showScreen('screen-room');
            document.getElementById('roomIdDisplay').textContent = roomId;

            unsubscribeRoom = onSnapshot(doc(db, "rooms", roomId), (docSnap) => {
                if(!docSnap.exists()) { showToast("‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∏‡∏ö", 'error'); leaveRoom(); return; }
                const data = docSnap.data();
                isHost = (data.host === currentUser);
                
                if(data.status === 'waiting') {
                    document.getElementById('roomTitleDisplay').textContent = data.name;
                    document.getElementById('playerCountDisplay').textContent = `${data.players.length}/${data.maxPlayers}`;
                    document.getElementById('playerList').innerHTML = data.players.map(p => 
                        `<div class="bg-slate-800 p-3 rounded-xl flex items-center gap-2 border ${p===data.host?'border-red-500 shadow-[0_0_10px_rgba(239,68,68,0.2)]':'border-slate-700'}">
                            <div class="w-2 h-2 rounded-full ${p===data.host?'bg-red-500':'bg-slate-500'}"></div>
                            <span class="font-bold truncate text-sm text-slate-200">${p}</span>
                        </div>`
                    ).join('');
                    
                    if(isHost) {
                        document.getElementById('btnStartGame').classList.remove('hidden');
                        document.getElementById('waitingHostText').classList.add('hidden');
                        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏™)
                    } else {
                        document.getElementById('btnStartGame').classList.add('hidden');
                        document.getElementById('waitingHostText').classList.remove('hidden');
                    }
                } else {
                    handleGameEngine(data);
                }
            });
        };

        document.getElementById('btnCreateRoom').addEventListener('click', async () => {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            await setDoc(doc(db, "rooms", roomId), {
                name: document.getElementById('roomNameInput').value || `‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á ${currentUser}`,
                host: currentUser, maxPlayers: parseInt(document.getElementById('playerCount').value),
                status: "waiting", players: [currentUser], alive: [currentUser],
                roles: {}, phase: "setup", dayCount: 1,
                actions: {}, // ‡πÄ‡∏Å‡πá‡∏ö action ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô
                votes: {},   // ‡πÄ‡∏Å‡πá‡∏ö vote ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô
                log: ""
            });
            joinRoom(roomId);
            showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        });

        document.getElementById('btnJoinRoom').addEventListener('click', async () => {
            const code = document.getElementById('joinRoomCode').value.toUpperCase();
            if(!code) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™', 'error');
            const ref = doc(db, "rooms", code);
            const snap = await getDoc(ref);
            if(snap.exists() && snap.data().status === 'waiting') {
                if(!snap.data().players.includes(currentUser)) await updateDoc(ref, { players: arrayUnion(currentUser), alive: arrayUnion(currentUser) });
                joinRoom(code);
                showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
        });

        const leaveRoom = () => {
            if(unsubscribeRoom) unsubscribeRoom();
            currentRoomId = null; showScreen('screen-lobby');
        };
        document.getElementById('btnLeaveRoom').addEventListener('click', leaveRoom);

        // --- THE GOD ENGINE V2 (Automated Gameplay) ---

        document.getElementById('btnStartGame').addEventListener('click', async () => {
            const ref = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(ref);
            const players = snap.data().players;
            
            // ‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏û‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
            let deck = generateDeck(players.length);
            let roles = {};
            players.forEach((p, i) => roles[p] = deck[i]);

            await updateDoc(ref, { status: "playing", phase: "night", roles: roles, log: "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤... ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏£‡∏Å" });
        });

        function handleGameEngine(data) {
            showScreen('screen-gameplay');
            currentPhase = data.phase;
            myRole = data.roles[currentUser] || "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô";
            isDead = !data.alive.includes(currentUser);

            // ‡πÄ‡∏ã‡πá‡∏ï UI ‡∏Å‡∏≤‡∏£‡πå‡∏î
            document.getElementById('myRoleName').textContent = myRole;
            document.getElementById('myRoleImage').src = roleImages[myRole] || "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô.jpg";
            if(isDead) document.getElementById('myRoleName').textContent = myRole + " (‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì üëª)";

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° UI ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
            const actionZone = document.getElementById('actionZone');
            const targetList = document.getElementById('targetList');
            const phaseTitle = document.getElementById('phaseTitle');
            const phaseDesc = document.getElementById('phaseDesc');
            
            actionZone.classList.add('hidden');
            targetList.innerHTML = '';
            document.getElementById('btnConfirmAction').classList.add('hidden');
            selectedTarget = null;
            document.getElementById('dayCounter').textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.dayCount}`;

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô/‡∏ï‡∏≤‡∏¢
            renderAliveList(data.players, data.alive);

            // ==========================================
            // üåô ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô (Night Phase)
            // ==========================================
            if(currentPhase === "night") {
                setTheme('theme-night');
                phaseTitle.textContent = "‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô";
                phaseDesc.textContent = "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...";
                document.getElementById('btnHostForceDay').classList.add('hidden');
                document.getElementById('voteCountTracker').classList.add('hidden');

                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤
                if(myRole === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤" && !isDead && !data.actions[currentUser]) showToast('‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß!', 'wolf');

                // ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á
                if(!isDead && !data.actions[currentUser]) {
                    const aliveOthers = data.alive.filter(p => p !== currentUser);
                    
                    if(myRole === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤") {
                        showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠ ü©∏", aliveOthers, "kill");
                    } else if (myRole === "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå") {
                        showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô üîÆ", aliveOthers, "check");
                    } else if (myRole === "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î") {
                        showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô üõ°Ô∏è", data.alive, "protect"); // ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏ä‡∏≠‡∏ö)
                    }
                } else if (!isDead && data.actions[currentUser]) {
                    phaseDesc.textContent = "‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÄ‡∏ä‡πâ‡∏≤...";
                } else if (isDead) {
                    phaseDesc.textContent = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì ‡∏£‡∏≠‡πÄ‡∏ä‡πâ‡∏≤...";
                }

                if(isHost) processNightEnd(data);
            } 
            
            // ==========================================
            // ‚òÄÔ∏è ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ (Day Phase)
            // ==========================================
            else if (currentPhase === "day") {
                setTheme(data.log.includes("‡∏ï‡∏≤‡∏¢") ? 'theme-blood' : 'theme-day');
                phaseTitle.textContent = "‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ ‚òÄÔ∏è";
                phaseDesc.innerHTML = `<span class="font-bold text-xl">${data.log}</span><br><br>‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤!`;
                
                // Host ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏ß‡∏ï
                if(isHost) {
                    document.getElementById('btnHostForceDay').textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ ‚öñÔ∏è";
                    document.getElementById('btnHostForceDay').classList.remove('hidden');
                    document.getElementById('btnHostForceDay').onclick = () => updateDoc(doc(db, "rooms", currentRoomId), { phase: "voting", votes: {} });
                }
            }

            // ==========================================
            // ‚öñÔ∏è ‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ (Voting Phase)
            // ==========================================
            else if (currentPhase === "voting") {
                setTheme('theme-day');
                phaseTitle.textContent = "‡πÇ‡∏´‡∏ß‡∏ï‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£ ‚öñÔ∏è";
                phaseDesc.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°)";
                
                document.getElementById('btnHostForceDay').classList.add('hidden');
                
                // ‡πÇ‡∏ä‡∏ß‡πå Tracker ‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                const voteCount = Object.keys(data.votes || {}).length;
                const tracker = document.getElementById('voteCountTracker');
                tracker.textContent = `‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß: ${voteCount}/${data.alive.length}`;
                tracker.classList.remove('hidden');

                if(!isDead && !data.votes[currentUser]) {
                    showActionPanel("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏ß‡∏ï‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£ üíÄ", data.alive, "vote");
                } else if (!isDead) {
                    phaseDesc.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ${data.alive.length - voteCount} ‡∏Ñ‡∏ô...`;
                }

                if(isHost) processVoteEnd(data);
            }

            // ==========================================
            // üèÜ ‡∏à‡∏ö‡πÄ‡∏Å‡∏° (Ended)
            // ==========================================
            else if (currentPhase === "ended") {
                setTheme(data.log.includes("‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô") ? 'theme-day' : 'theme-blood');
                phaseTitle.textContent = "‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß! üéä";
                phaseDesc.innerHTML = `<span class="font-bold text-2xl">${data.log}</span>`;
            }
        }

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Theme
        function setTheme(themeName) {
            document.body.classList.remove('theme-night', 'theme-day', 'theme-blood');
            document.body.classList.add(themeName);
        }

        // ‡∏ß‡∏≤‡∏î UI ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô
        function renderAliveList(allPlayers, alivePlayers) {
            const list = document.getElementById('aliveListUI');
            list.innerHTML = allPlayers.map(p => {
                const isAlive = alivePlayers.includes(p);
                return `<span class="px-3 py-1.5 rounded-lg text-sm font-bold border ${isAlive ? 'bg-slate-800 border-slate-600 text-white' : 'bg-red-900/30 border-red-900 text-red-500 line-through'}">${p} ${p===currentUser?'(‡∏Ñ‡∏∏‡∏ì)':''}</span>`;
            }).join('');
        }

        // ‡∏ß‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡πà‡∏ô
        function showActionPanel(title, targets, type) {
            document.getElementById('actionZone').classList.remove('hidden');
            document.getElementById('actionTitle').textContent = title;
            const list = document.getElementById('targetList');
            
            targets.forEach(t => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-800 hover:bg-slate-700 p-3 rounded-xl border border-slate-600 font-bold transition-all text-white";
                btn.textContent = t;
                btn.onclick = () => {
                    [...list.children].forEach(c => c.classList.remove('ring-2', 'ring-yellow-500', 'bg-slate-700'));
                    btn.classList.add('ring-2', 'ring-yellow-500', 'bg-slate-700');
                    selectedTarget = t;
                    const btnConfirm = document.getElementById('btnConfirmAction');
                    btnConfirm.classList.remove('hidden');
                    btnConfirm.onclick = () => submitAction(type);
                };
                list.appendChild(btn);
            });
        }

        async function submitAction(type) {
            document.getElementById('actionZone').classList.add('hidden');
            const ref = doc(db, "rooms", currentRoomId);
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ü‡πà‡∏≤)
            if(type === "check") {
                const docSnap = await getDoc(ref);
                const role = docSnap.data().roles[selectedTarget];
                // [cite: 20] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const isWolf = role === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤"; 
                showToast(`${selectedTarget} ${isWolf ? '‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤! üê∫' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ üßë‚Äçüåæ'}`, isWolf ? 'error' : 'success');
                // ‡πÅ‡∏Ñ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏π‡πâ
                await updateDoc(ref, { [`actions.${currentUser}`]: "checked" });
            } 
            else if (type === "vote") {
                await updateDoc(ref, { [`votes.${currentUser}`]: selectedTarget });
            } 
            else { // ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Ü‡πà‡∏≤ (kill) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á (protect)
                await updateDoc(ref, { [`actions.${currentUser}`]: { type: type, target: selectedTarget } });
            }
        }

        // === Host Engine: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ===
        async function processNightEnd(data) {
            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà (‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤, ‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå, ‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î)
            const activeRoles = ["‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤", "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå", "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î"];
            const requiredActions = data.alive.filter(p => activeRoles.includes(data.roles[p]));
            const actionsDone = Object.keys(data.actions || {});

            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            if(actionsDone.length >= requiredActions.length && requiredActions.length > 0) {
                let wolfTarget = null;
                let protectTarget = null;

                // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                Object.values(data.actions).forEach(action => {
                    if(action && action.type === 'kill') wolfTarget = action.target;
                    if(action && action.type === 'protect') protectTarget = action.target;
                });

                let msg = "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏á‡∏ö‡∏™‡∏∏‡∏Ç ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï üïäÔ∏è";
                let newAlive = [...data.alive];

                // ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Å‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô
                if (wolfTarget && wolfTarget !== protectTarget) {
                    newAlive = newAlive.filter(p => p !== wolfTarget);
                    msg = `‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏¢ 1 ‡∏Ñ‡∏ô... ‡∏®‡∏û‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠ ${wolfTarget} ü©∏`;
                } else if (wolfTarget && wolfTarget === protectTarget) {
                    msg = "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏•‡πà‡∏≤... ‡πÅ‡∏ï‡πà‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ! üõ°Ô∏è";
                }

                await updateDoc(doc(db, "rooms", currentRoomId), {
                    phase: "day", alive: newAlive, actions: {}, log: msg
                });
                checkWin(newAlive, data.roles);
            }
        }

        // === Host Engine: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô ===
        async function processVoteEnd(data) {
            const votesDone = Object.keys(data.votes || {});
            
            if(votesDone.length >= data.alive.length) {
                const counts = {};
                Object.values(data.votes).forEach(t => counts[t] = (counts[t] || 0) + 1);
                
                // ‡∏´‡∏≤‡∏Ñ‡∏ô‡πÇ‡∏î‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î
                const hanged = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

                const newAlive = data.alive.filter(p => p !== hanged);
                const msg = `‡∏°‡∏ï‡∏¥‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ ${hanged}! (‡∏û‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏∑‡∏≠ ${data.roles[hanged]}) ü™¢`;

                await updateDoc(doc(db, "rooms", currentRoomId), {
                    phase: "night", alive: newAlive, votes: {}, log: msg, dayCount: (data.dayCount || 1) + 1
                });
                checkWin(newAlive, data.roles);
            }
        }

        // === Host Engine: ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ===
        async function checkWin(aliveList, rolesMap) {
            const wolves = aliveList.filter(p => rolesMap[p] === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤").length;
            const villagers = aliveList.length - wolves;

            let endMsg = null;
            if(wolves === 0) endMsg = "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ô‡∏∞! ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß üéä";
            else if(wolves >= villagers) endMsg = "‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ä‡∏ô‡∏∞! ‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏£‡∏≠‡∏á‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô üê∫";

            if(endMsg) {
                await updateDoc(doc(db, "rooms", currentRoomId), { phase: "ended", log: endMsg });
            }
        }

        // ‡∏û‡∏•‡∏¥‡∏Å‡πÑ‡∏û‡πà
        document.getElementById('myCard').addEventListener('click', function() { this.classList.toggle('flipped'); });

    </script>
</body>
</html>
