<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Werewolf Online - ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡πÇ‡∏ï‡πâ‡∏£‡∏±‡∏ô</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 1s ease;
        }
        /* ‡∏ò‡∏µ‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô - ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô */
        body.theme-night { background-image: radial-gradient(circle at top, #1e293b, #020617); }
        body.theme-day { background-image: radial-gradient(circle at top, #38bdf8, #0f172a); }

        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .screen { transition: opacity 0.4s ease, transform 0.4s ease; }
        .hide-screen { opacity: 0; transform: scale(0.95); pointer-events: none; position: absolute; visibility: hidden; }
        .show-screen { opacity: 1; transform: scale(1); position: relative; visibility: visible; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        #toast-container { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #ef4444; color: white; padding: 14px 16px; border-radius: 8px; transform: translateY(-150%); transition: transform 0.4s; font-size: 0.95rem; }
        .toast.show { transform: translateY(0); }
        .toast.success { border-left-color: #22c55e; }
        .toast.info { border-left-color: #3b82f6; }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î 3D */
        .flip-card { width: 100%; max-width: 240px; aspect-ratio: 2/3; perspective: 1000px; cursor: pointer; margin: 0 auto; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.5); overflow: hidden; }
        .flip-card-front { background: linear-gradient(135deg, #1e293b, #0f172a); display: flex; align-items: center; justify-content: center; border: 2px solid #334155; }
        .flip-card-front::after { content: "WEREWOLF\A‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà"; white-space: pre; color: #ef4444; font-size: 1.25rem; font-weight: bold; }
        .flip-card-back { background-color: #1e293b; transform: rotateY(180deg); border: 2px solid #ef4444; }
        .flip-card-back img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="flex items-center justify-center p-4 md:p-6 min-h-[100dvh] theme-night">

    <div id="toast-container"></div>

    <div id="screen-login" class="screen show-screen glass-panel p-8 rounded-3xl w-full max-w-md text-center">
        <h1 class="text-4xl font-extrabold text-red-500 mb-2">WEREWOLF</h1>
        <p class="text-slate-400 mb-6">‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ... ‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞‡∏£‡∏≠‡∏î?</p>
        <input type="text" id="playerNameInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="w-full mb-6 px-4 py-3 bg-slate-800 border border-slate-600 rounded-xl focus:border-red-500 text-center text-white">
        <button id="btnSaveName" class="w-full bg-red-600 hover:bg-red-700 py-3 rounded-xl font-bold transition-all text-white">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</button>
    </div>

    <div id="screen-lobby" class="screen hide-screen glass-panel p-8 rounded-3xl w-full max-w-3xl">
        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
            <h2 class="text-2xl font-bold">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <div class="text-right">
                <span id="displayPlayerName" class="font-bold text-red-400"></span>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-800/40 p-6 rounded-xl border border-slate-700">
                <h3 class="font-bold mb-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
                <input type="text" id="roomNameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á..." class="w-full mb-4 px-3 py-2 bg-slate-900 rounded border border-slate-600">
                <select id="playerCount" class="w-full mb-4 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white">
                    <option value="5">5 ‡∏Ñ‡∏ô</option>
                    <option value="7">7 ‡∏Ñ‡∏ô</option>
                    <option value="10" selected>10 ‡∏Ñ‡∏ô</option>
                </select>
                <button id="btnCreateRoom" class="w-full bg-red-600 py-2 rounded font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
            </div>
            <div class="bg-slate-800/40 p-6 rounded-xl border border-slate-700">
                <h3 class="font-bold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™</h3>
                <input type="text" id="joinRoomCode" placeholder="‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å" class="w-full mb-4 px-3 py-2 bg-slate-900 rounded border border-slate-600 text-center tracking-widest uppercase">
                <button id="btnJoinRoom" class="w-full bg-blue-600 py-2 rounded font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
            </div>
        </div>
    </div>

    <div id="screen-room" class="screen hide-screen glass-panel p-8 rounded-3xl w-full max-w-2xl text-center">
        <h2 id="roomTitleDisplay" class="text-3xl font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</h2>
        <p class="text-slate-400 mb-6">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç: <span id="roomIdDisplay" class="font-mono text-white bg-slate-800 px-2 rounded tracking-widest">---</span></p>
        
        <div class="bg-slate-900 p-4 rounded-xl mb-6">
            <h3 class="text-sm text-slate-400 mb-3">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (<span id="playerCountDisplay">0/0</span>)</h3>
            <div id="playerList" class="grid grid-cols-2 gap-3 text-left"></div>
        </div>
        <button id="btnStartGame" class="w-full bg-red-600 py-3 rounded-xl font-bold hidden">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!</button>
        <p id="waitingHostText" class="text-slate-400 hidden">‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</p>
    </div>

    <div id="screen-gameplay" class="screen hide-screen w-full max-w-xl text-center">
        
        <div id="gameStatusZone" class="glass-panel p-6 rounded-3xl mb-6 border-t-4 border-indigo-500">
            <h2 id="phaseTitle" class="text-3xl font-bold text-white mb-2">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô</h2>
            <p id="phaseDesc" class="text-slate-300">‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠...</p>
        </div>

        <div id="myCardZone" class="mb-6">
            <div class="flip-card" id="myCard">
                <div class="flip-card-inner">
                    <div class="flip-card-front"></div>
                    <div class="flip-card-back">
                        <img id="myRoleImage" src="" alt="Role">
                    </div>
                </div>
            </div>
            <p class="mt-4 text-xl font-bold text-red-400" id="myRoleName">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</p>
        </div>

        <div id="actionZone" class="glass-panel p-6 rounded-3xl hidden">
            <h3 id="actionTitle" class="text-xl font-bold mb-4 text-yellow-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
            <div id="targetList" class="grid grid-cols-2 gap-3">
                </div>
            <button id="btnConfirmAction" class="mt-6 w-full bg-yellow-600 py-2 rounded-xl font-bold hidden">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!
        const firebaseConfig = {
            apiKey: "AIzaSyAzA-3TJ4lcNOFUGoOVd8JhExoeIRxSsFU",
            authDomain: "wolf-ba81b.firebaseapp.com",
            projectId: "wolf-ba81b",
            storageBucket: "wolf-ba81b.firebasestorage.app",
            messagingSenderId: "310182298514",
            appId: "1:310182298514:web:804e92316d5aca0770b74b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = localStorage.getItem('ww_name') || "";
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let isHost = false;
        let myRole = "";
        let isDead = false;
        let selectedTarget = null;

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        const roleImages = {
            "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤": "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤.jpg",
            "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô": "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô.jpg",
            "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå": "‡πÄ‡∏ó‡∏û‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå.jpg",
            "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î": "‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î.jpg"
            // ‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        };

        // UI Helpers
        const showToast = (msg, type='info') => { /* (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Toast ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) */ 
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type} flex gap-2`;
            toast.innerHTML = `<span>${type==='success'?'‚úÖ':'üîî'}</span> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.remove(),400); }, 2500);
        };
        const showScreen = (id) => {
            ['screen-login', 'screen-lobby', 'screen-room', 'screen-gameplay'].forEach(s => {
                document.getElementById(s).classList.toggle('hide-screen', s !== id);
                document.getElementById(s).classList.toggle('show-screen', s === id);
            });
        };

        // Init
        if(currentUser) {
            document.getElementById('displayPlayerName').textContent = currentUser;
            showScreen('screen-lobby');
        } else {
            showScreen('screen-login');
        }

        document.getElementById('btnSaveName').addEventListener('click', () => {
            const name = document.getElementById('playerNameInput').value.trim();
            if(name) { currentUser = name; localStorage.setItem('ww_name', name); document.getElementById('displayPlayerName').textContent = currentUser; showScreen('screen-lobby'); }
        });

        // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á / ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á
        const joinRoom = (roomId, isCreating = false) => {
            currentRoomId = roomId;
            showScreen('screen-room');
            document.getElementById('roomIdDisplay').textContent = roomId;

            unsubscribeRoom = onSnapshot(doc(db, "rooms", roomId), (docSnap) => {
                if(!docSnap.exists()) return;
                const data = docSnap.data();
                isHost = (data.host === currentUser);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏£‡∏≠
                if(data.status === 'waiting') {
                    document.getElementById('roomTitleDisplay').textContent = data.name;
                    document.getElementById('playerCountDisplay').textContent = `${data.players.length}/${data.maxPlayers}`;
                    document.getElementById('playerList').innerHTML = data.players.map(p => `<div class="bg-slate-800 p-2 rounded truncate ${p===data.host?'border border-red-500':''}">${p}</div>`).join('');
                    
                    if(isHost) {
                        document.getElementById('btnStartGame').classList.remove('hidden');
                        document.getElementById('waitingHostText').classList.add('hidden');
                    } else {
                        document.getElementById('btnStartGame').classList.add('hidden');
                        document.getElementById('waitingHostText').classList.remove('hidden');
                    }
                } 
                // ‡∏ï‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏•‡∏¢‡πå
                else {
                    handleGamePhase(data);
                }
            });
        };

        document.getElementById('btnCreateRoom').addEventListener('click', async () => {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            await setDoc(doc(db, "rooms", roomId), {
                name: document.getElementById('roomNameInput').value || `‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á ${currentUser}`,
                host: currentUser, maxPlayers: parseInt(document.getElementById('playerCount').value),
                status: "waiting", players: [currentUser], alive: [currentUser],
                roles: {}, phase: "setup", nightActions: {}, votes: {}
            });
            joinRoom(roomId, true);
        });

        document.getElementById('btnJoinRoom').addEventListener('click', async () => {
            const code = document.getElementById('joinRoomCode').value.toUpperCase();
            const ref = doc(db, "rooms", code);
            const snap = await getDoc(ref);
            if(snap.exists() && snap.data().status === 'waiting') {
                if(!snap.data().players.includes(currentUser)) await updateDoc(ref, { players: arrayUnion(currentUser), alive: arrayUnion(currentUser) });
                joinRoom(code);
            } else showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
        });

        // ---------------------------------------------------------
        // THE GOD SYSTEM (Automated Game Engine)
        // ---------------------------------------------------------
        
        // Host ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
        document.getElementById('btnStartGame').addEventListener('click', async () => {
            const ref = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(ref);
            const players = snap.data().players;
            
            // ‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏û‡πà‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏™‡∏π‡∏ï‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ)
            let deck = ["‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤", ...Array(players.length-1).fill("‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô")];
            deck.sort(() => Math.random() - 0.5);
            
            let roles = {};
            players.forEach((p, i) => roles[p] = deck[i]);

            await updateDoc(ref, { status: "playing", phase: "night", roles: roles, log: "‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤..." });
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ State ‡πÄ‡∏Å‡∏°
        function handleGamePhase(data) {
            showScreen('screen-gameplay');
            
            myRole = data.roles[currentUser];
            isDead = !data.alive.includes(currentUser);

            // ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πå‡∏î
            document.getElementById('myRoleName').textContent = myRole;
            document.getElementById('myRoleImage').src = roleImages[myRole] || "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô.jpg";

            const phaseTitle = document.getElementById('phaseTitle');
            const phaseDesc = document.getElementById('phaseDesc');
            const actionZone = document.getElementById('actionZone');
            const targetList = document.getElementById('targetList');

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UI Action
            actionZone.classList.add('hidden');
            targetList.innerHTML = '';
            selectedTarget = null;

            // üåô ‡πÄ‡∏ü‡∏™‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô
            if(data.phase === "night") {
                document.body.className = "flex items-center justify-center p-6 min-h-[100dvh] theme-night";
                phaseTitle.textContent = "‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô üåô";
                phaseDesc.textContent = "‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏ö‡πÉ‡∏´‡∏• ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠...";

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏ß‡∏ï‡∏Ü‡πà‡∏≤‡πÑ‡∏î‡πâ
                if(myRole === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤" && !isDead) {
                    if(!data.nightActions[currentUser]) {
                        actionZone.classList.remove('hidden');
                        document.getElementById('actionTitle').textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏î";
                        renderTargetButtons(data.alive.filter(p => p !== currentUser), "night");
                    } else {
                        phaseDesc.textContent = "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô / ‡∏£‡∏≠‡πÄ‡∏ä‡πâ‡∏≤...";
                    }
                }
                
                // [Host Logic] ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡πÇ‡∏´‡∏ß‡∏ï‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß Host ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                if(isHost) checkNightEndAndWakeUp(data);
            } 
            
            // ‚òÄÔ∏è ‡πÄ‡∏ü‡∏™‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏ï‡∏≤‡∏¢ & ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤)
            else if (data.phase === "day") {
                document.body.className = "flex items-center justify-center p-6 min-h-[100dvh] theme-day";
                phaseTitle.textContent = "‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ ‚òÄÔ∏è";
                phaseDesc.textContent = data.log || "‡∏ï‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ";
                
                // [Host Logic] Host ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠
                if(isHost && !isDead) {
                    actionZone.classList.remove('hidden');
                    document.getElementById('actionTitle').textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠";
                    targetList.innerHTML = `<button id="btnStartVote" class="col-span-2 bg-blue-600 p-3 rounded text-white font-bold">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏ß‡∏ï!</button>`;
                    document.getElementById('btnStartVote').onclick = () => updateDoc(doc(db, "rooms", currentRoomId), { phase: "voting", votes: {} });
                }
            }

            // ‚öñÔ∏è ‡πÄ‡∏ü‡∏™‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠
            else if (data.phase === "voting") {
                phaseTitle.textContent = "‡πÇ‡∏´‡∏ß‡∏ï‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£ ‚öñÔ∏è";
                phaseDesc.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤";
                
                if(!isDead && !data.votes[currentUser]) {
                    actionZone.classList.remove('hidden');
                    document.getElementById('actionTitle').textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÇ‡∏´‡∏ß‡∏ï‡∏≠‡∏≠‡∏Å";
                    renderTargetButtons(data.alive, "vote");
                } else if (!isDead) {
                    phaseDesc.textContent = "‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÇ‡∏´‡∏ß‡∏ï...";
                } else {
                    phaseDesc.textContent = "‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏ú‡∏π‡πâ‡∏ä‡∏°‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì üëª";
                }

                if(isHost) checkVoteEnd(data);
            }
            
            // üèÜ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°
            else if (data.phase === "ended") {
                phaseTitle.textContent = "‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß! üéâ";
                phaseDesc.textContent = data.log;
            }
        }

        // ‡∏ß‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        function renderTargetButtons(targets, actionType) {
            const list = document.getElementById('targetList');
            targets.forEach(t => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-700 hover:bg-red-600 p-3 rounded border border-slate-600 transition-all text-white font-bold";
                btn.textContent = t;
                btn.onclick = () => {
                    [...list.children].forEach(c => c.classList.remove('ring-4', 'ring-red-400', 'bg-red-600'));
                    btn.classList.add('ring-4', 'ring-red-400', 'bg-red-600');
                    selectedTarget = t;
                    
                    const btnConfirm = document.getElementById('btnConfirmAction');
                    btnConfirm.classList.remove('hidden');
                    btnConfirm.onclick = () => submitAction(actionType);
                };
                list.appendChild(btn);
            });
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Firebase
        async function submitAction(type) {
            document.getElementById('actionZone').classList.add('hidden');
            const ref = doc(db, "rooms", currentRoomId);
            if(type === "night") {
                await updateDoc(ref, { [`nightActions.${currentUser}`]: selectedTarget });
            } else if (type === "vote") {
                await updateDoc(ref, { [`votes.${currentUser}`]: selectedTarget });
            }
        }

        // === Host Engine: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô ===
        async function checkNightEndAndWakeUp(data) {
            // ‡∏ô‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏î‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô
            const aliveWolves = data.alive.filter(p => data.roles[p] === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤");
            const actionsCount = Object.keys(data.nightActions || {}).length;

            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß
            if(actionsCount >= aliveWolves.length && aliveWolves.length > 0) {
                // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î
                const targetCounts = {};
                Object.values(data.nightActions).forEach(t => targetCounts[t] = (targetCounts[t] || 0) + 1);
                const victim = Object.keys(targetCounts).reduce((a, b) => targetCounts[a] > targetCounts[b] ? a : b);

                // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô
                const newAlive = data.alive.filter(p => p !== victim);
                const msg = `‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏¢ 1 ‡∏Ñ‡∏ô... ‡∏®‡∏û‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠ ${victim} ü©∏`;

                await updateDoc(doc(db, "rooms", currentRoomId), {
                    phase: "day", alive: newAlive, nightActions: {}, log: msg
                });
                checkWinCondition(newAlive, data.roles);
            }
        }

        // === Host Engine: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô ===
        async function checkVoteEnd(data) {
            const votesCount = Object.keys(data.votes || {}).length;
            
            // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            if(votesCount >= data.alive.length) {
                const targetCounts = {};
                Object.values(data.votes).forEach(t => targetCounts[t] = (targetCounts[t] || 0) + 1);
                // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î
                const hanged = Object.keys(targetCounts).reduce((a, b) => targetCounts[a] > targetCounts[b] ? a : b);

                const newAlive = data.alive.filter(p => p !== hanged);
                const msg = `‡∏°‡∏ï‡∏¥‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠ ${hanged}! (‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏∑‡∏≠ ${data.roles[hanged]})`;

                await updateDoc(doc(db, "rooms", currentRoomId), {
                    phase: "night", alive: newAlive, votes: {}, log: msg
                });
                checkWinCondition(newAlive, data.roles);
            }
        }

        // === Host Engine: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞ ===
        async function checkWinCondition(aliveList, rolesMap) {
            const wolvesCount = aliveList.filter(p => rolesMap[p] === "‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤").length;
            const villagerCount = aliveList.length - wolvesCount;

            let endMsg = null;
            if(wolvesCount === 0) endMsg = "‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏ô‡∏∞! ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß üéä";
            else if(wolvesCount >= villagerCount) endMsg = "‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ä‡∏ô‡∏∞! ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üê∫";

            if(endMsg) {
                await updateDoc(doc(db, "rooms", currentRoomId), { phase: "ended", log: endMsg });
            }
        }

        // ‡∏û‡∏•‡∏¥‡∏Å‡πÑ‡∏û‡πà
        document.getElementById('myCard').addEventListener('click', function() {
            this.classList.toggle('flipped');
        });

    </script>
</body>
</html>.
